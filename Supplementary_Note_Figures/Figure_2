# Clear workspace
rm(list = ls())

# Load packages
library(Seurat)
library(tidyverse)
library(viridis)
library(SCopeLoomR)
library(SCENIC)

# Load endothelial dataset and palette
endo_fetal<-readRDS('endo_fetal_lung.rds')
endo_palette<-readRDS('endo_palette.rds')

## Supplementary Note Fig 2A

p1<-DimPlot(endo_fetal, cols = endo_palette)
p1$data$num_ident<-endo_fetal@meta.data$num_ident
LabelClusters(p1, id ='num_ident')

ggsave("Fig_2A.pdf", width = 15, height = 9)

## Supplementary Note Fig 2B

pt <- table(endo_fetal$cell_type, endo_fetal$sample_week)
pt <- as.data.frame(pt)
ggplot(pt, aes(x = Var2, y = Freq, fill = Var1)) +
    theme_bw(base_size = 15) +
    geom_col(colour = "black", position = "fill") +
    xlab("Sample") +
    ylab("Proportion") +
    theme(legend.title = element_blank())+
    theme(axis.text.x = element_text(angle = 90)) +
    theme(axis.text = element_text(size=25), axis.title = element_text(size=25)) +
    theme(legend.text=element_text(size=20)) +
    scale_fill_manual(values = endo_palette) +
    NoLegend()
ggsave("Fig_2B.pdf", width = 15, height = 9)

## Supplementary Note Fig 2C

# Load DEG table for endothelial cluster

DEG_markers<-read.csv('c1_markers.csv')
top3<- all_markers_res_0_01 %>% group_by(cluster) %>% top_n(n = 3, wt = avg_log2FC)
features = top3$gene

# DEG features that were chosen
chosen_features = c('TCF21', 'PLEKHH2', 'FOS', 'EGR1', 'MKI67', 'TIMP3', 'LGALS3', 'MYH11', 'TMEM158')
endo_features <- c(features, chosen_features)

# Change the order of the features to match up with the figure; or can load in the features already ordered
ordered_endo_features <- readRDS('ordered_endo_features.rds')

# Generate heatmap
DoHeatmap(endo_fetal, assay = 'RNA', features = ordered_endo_features, size = 4, angle = 90) +
scale_fill_viridis(option = "D") + guides(color = "none")+ theme(axis.title = element_text(size=30)) +theme(axis.text.y = element_text(size = 30))
ggsave("Fig_2C.pdf", width = 40, height = 18)

## Supplementary Note Fig 2D

# Load in output loom files from pyscenic & list of top transcription factors
endo_loom <- open_loom('c3_scenic_integrated-output.loom')
endo_top_tf <- readRDS('c3_top_tf.rds')

# Read information from output loom files
regulonAUC <- get_regulons_AUC(endo_loom, column.attr.name = 'RegulonsAUC')
regulonAucThresholds <- get_regulon_thresholds(endo_loom)
embeddings <- get_embeddings(endo_loom)
cells<-regulonAUC@colData@rownames

endo_fetal<-subset(endo_fetal, cells = cells)
cellInfo<-data.frame(CellType=Idents(endo_fetal))
endo_top_tf=paste0(endo_top_tf,"_(+)")

# Sort regulons by top transcription factors
regulonAUC <- regulonAUC[rownames(regulonAUC) %in% endo_top_tf,]

# Generate heatmap based on regulon activity

row_names <- levels(endo_fetal)
regulonAUC <- regulonAUC[onlyNonDuplicatedExtended(rownames(regulonAUC)),]
regulonActivity_byCellType <- sapply(split(rownames(cellInfo), cellInfo$CellType),
                                     function(cells) rowMeans(getAUC(regulonAUC)[,cells]))
regulonActivity_byCellType_Scaled <- t(scale(t(regulonActivity_byCellType), center = T, scale=T))

ComplexHeatmap::Heatmap(t(regulonActivity_byCellType_Scaled), name="Regulon activity", row_order = c(1:10), column_order = endo_top_tf,row_labels = row_names, row_names_side = 'left')

ggsave("Fig_2D.pdf", width = 40, height = 18)
